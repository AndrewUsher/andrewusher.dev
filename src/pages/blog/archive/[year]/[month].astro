---
import type { GetStaticPaths } from 'astro'
import {
  getArchiveData,
  getPostsByMonth,
} from '../../../../lib/archive'
import { calculateReadingTime } from '../../../../lib/calculateReadingTime'
import BaseLayout from '../../../../layouts/BaseLayout.astro'
import Posts from '../../../../components/Posts.astro'
import Breadcrumbs from '../../../../components/Breadcrumbs.astro'

export const prerender = true;

export const getStaticPaths = (async () => {
  const archiveData = await getArchiveData()
  const paths = []

  for (const yearInfo of archiveData) {
    for (const month of yearInfo.months) {
      paths.push({
        params: {
          year: yearInfo.year.toString(),
          month: month.slug,
        },
        props: {
          monthName: month.name,
        },
      })
    }
  }

  return paths
}) satisfies GetStaticPaths

const { year, month } = Astro.params
const { monthName } = Astro.props
const yearNumber = parseInt(year, 10)
const posts = await getPostsByMonth(yearNumber, month)

const postsWithReadingTime = posts.map(post => ({
  ...post,
  readingTime: calculateReadingTime(post.body ?? ''),
}))
---

<BaseLayout>
  <main class="mx-auto max-w-screen-xl p-8">
    <div class="mb-8">
      <Breadcrumbs
        items={[
          { label: 'Home', href: '/' },
          { label: 'Blog', href: '/blog' },
          { label: 'Archive', href: '/blog/archive' },
          { label: year, href: `/blog/archive/${year}` },
          { label: monthName },
        ]}
      />

      <h1 class="mb-4 text-4xl font-bold dark:text-white">
        Posts from {monthName} {year}
      </h1>
      <p class="text-lg text-slate-700 dark:text-slate-400">
        {postsWithReadingTime.length}
        {postsWithReadingTime.length === 1 ? 'post' : 'posts'} published in {
          monthName
        }
        {year}
      </p>
    </div>

    <Posts entrySlugStart="/blog" posts={postsWithReadingTime} />
  </main>
</BaseLayout>
