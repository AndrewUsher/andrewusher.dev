---
import type { GetStaticPaths } from "astro";
import { render } from "astro:content";
import { getEntry } from "astro:content";
import { getCollection } from "astro:content";
import { BlogPost } from "src/components/BlogPost";
import BaseLayout from "src/layouts/BaseLayout.astro";
import ReadingTime from "src/components/ReadingTime.astro";
import TagList from "src/components/TagList.astro";
import ViewCounter from "src/components/ViewCounter";
import { RecentlyViewedPosts } from "src/components/RecentlyViewedPosts";
import SimilarPosts from "src/components/SimilarPosts.astro";
import { calculateReadingTime } from "src/lib/calculateReadingTime";
import dayjs from "dayjs";
import Breadcrumbs from "src/components/Breadcrumbs.astro";

export const prerender = true;

export const getStaticPaths =  (async () => {
  const blogPosts = await getCollection('blogPosts')
  return blogPosts
    .filter(post => import.meta.env.DEV || post.data.isPublished)
    .map(post => ({
      params: { slug: post.data.slug },
    }));
}) satisfies GetStaticPaths;

const { slug } = Astro.params
const post = await getEntry('blogPosts', slug)
if (!post) {
  throw new Error(`Blog post not found with slug: ${slug}`);
}

const {Content} = await render(post)
const formattedPublishDate = dayjs(post.data.date).format('MMMM DD, YYYY')
const readingTime = calculateReadingTime(post.body)

---
---
<BaseLayout title={post.data.title} image={`/open-graph/${slug}.png`}>
  <div class="mx-auto max-w-screen-xl p-8 pt-0">
    <Breadcrumbs
      items={[
        { label: 'Home', href: '/' },
        { label: 'Blog', href: '/blog' },
        { label: post.data.title },
      ]}
    />
    <div class="relative left-[50%] right-[50%] ml-[-50vw] mr-[-50vw] w-screen bg-gradient-to-tl from-blue-400 to-emerald-400 py-20 px-4 text-center shadow-lg">
      <h1
        class="mb-1 break-words text-4xl font-bold text-black md:text-5xl"
        transition:name={`post-title-${slug}`}
        data-pagefind-meta="title"
      >
        {post.data.title}
      </h1>
      <div class="flex flex-col gap-2 items-center text-black md:text-lg">
        <time
          datetime={formattedPublishDate}
          class="text-base text-black md:text-lg"
          transition:name={`post-date-${slug}`}
        >
          Published on {formattedPublishDate}
        </time>
        <ReadingTime
          minutes={readingTime.minutes}
          display={readingTime.display}
          className="text-base text-black md:text-lg"
        />
        {post.data.tags && post.data.tags.length > 0 && (
          <TagList tags={post.data.tags} className="mt-2" />
        )}
      </div>
    </div>
    <div data-pagefind-body>
      {post.data.tags?.map((tag: string) => (
        <span data-pagefind-filter="tags" class="hidden">{tag}</span>
      ))}
      <div class="blog-layout">
        <div class="blog-content">
          <BlogPost post={post} pathname={Astro.url.pathname} client:load>
            <Content />
          </BlogPost>
        </div>
        <aside class="toc-sidebar hidden lg:block">
          <div class="toc-sticky" role="navigation" aria-label="Table of contents"></div>
        </aside>
      </div>
    </div>
    <SimilarPosts currentPost={post} />
    <div class="mt-8 text-center">
      <ViewCounter
        slug={slug}
        title={post.data.title}
        date={post.data.date.toISOString()}
        tags={post.data.tags}
        readingTime={readingTime.display}
        client:load
      />
    </div>
    <div class="mt-12">
      <RecentlyViewedPosts currentSlug={slug} client:load />
    </div>
  </div>
</BaseLayout>

<script is:inline>
  let tocObserver = null

  function setupTableOfContents() {
    const toc = document.querySelector('.toc')
    const tocSticky = document.querySelector('.toc-sticky')
    if (!toc || !tocSticky) return

    tocSticky.innerHTML = ''
    tocSticky.appendChild(toc)
    toc.classList.remove('hidden')
    document.documentElement.classList.add('toc-enhanced')

    const headings = document.querySelectorAll('main h2, main h3')
    const headingIds = new Set()

    headings.forEach((heading) => {
      if (heading.id) {
        headingIds.add(heading.id)
      }
    })

    headings.forEach((heading) => {
      if (!heading.id) {
        const textContent = heading.textContent ?? ''
        let id = textContent
          .toLowerCase()
          .replace(/<[^>]*>/g, '')
          .replace(/[^\w\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+$/, '')
          .replace(/^-+/, '')
        
        let uniqueId = id || 'section'
        let counter = 1
        while (headingIds.has(uniqueId)) {
          uniqueId = `${id}-${counter++}`
        }
        headingIds.add(uniqueId)
        heading.id = uniqueId
      }

      const link = toc.querySelector(`a[href="#${heading.id}"]`)
      if (link) {
        link.setAttribute('data-heading-id', heading.id)
      }
    })

    setupIntersectionObserver(toc)
  }

  function setupIntersectionObserver(toc) {
    if (tocObserver) {
      tocObserver.disconnect()
      tocObserver = null
    }

    const headings = document.querySelectorAll('main h2, main h3')
    tocObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const id = entry.target.id
          const links = toc.querySelectorAll('.toc-link')
          links.forEach(link => {
            link.classList.remove('toc-link-active')
            link.removeAttribute('aria-current')
            if (link.getAttribute('href') === `#${id}`) {
              link.classList.add('toc-link-active')
              link.setAttribute('aria-current', 'location')
            }
          })
        }
      })
    }, { rootMargin: '-80px 0px -66% 0px' })

    headings.forEach(heading => tocObserver.observe(heading))
  }

  function initTOC() {
    setupTableOfContents()
  }

  initTOC()
  document.addEventListener('astro:page-load', initTOC)
</script>

  
